# Results

```{r message=FALSE, warning=FALSE, include=FALSE}
library(readr)
df <- read_csv("C:/Users/chaoy/Desktop/Fall2021/5702_EDAV/finalproject_data/cash_information_clean.csv")

# df[sapply(df, is.character)] <- lapply(df[sapply(df, is.character)], as.factor)
```

## When
```{r include=FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(vcd)
library(patchwork)
```

### Time in Day
```{r fig.width=8, message=FALSE, warning=FALSE, echo=FALSE}
df_time <- df %>% select(Time, Year) %>%
  mutate(hour = hour(Time)) %>%
  group_by(hour, Year) %>%
  summarize(n = n()) %>%
  ungroup()

ggplot(df_time, aes(hour,n, fill=factor(Year))) + 
  geom_bar(stat="identity", position=position_dodge()) + 
  scale_fill_brewer(palette="Set2") +
  theme_minimal()
```
```{r fig.height=15, fig.width=20}
df_time_reason<- df %>% 
  mutate(time_hour = hour(Time)) %>%
  mutate(time_hour = factor(time_hour), 
         Lighting = ifelse(str_detect(`Lighting Conditions`, "Dark-Road"), 
                                        sub("^\\S+\\s+","", `Lighting Conditions`), as.character(`Lighting Conditions`)), 
          RoadDescriptor = abbreviate(`Road Descriptor`, 1, named = FALSE), 
         TrafficControlDevice = abbreviate(`Traffic Control Device`, 1, named = FALSE), 
         CrashDescriptor = abbreviate(`Crash Descriptor`, 1, named=FALSE), 
         CollisionTypeDescriptor = `Collision Type Descriptor`) %>%
  select(time_hour, CrashDescriptor, Lighting, RoadDescriptor, TrafficControlDevice, Collision_Detail, CollisionTypeDescriptor)

# pairs(table(df_time_reason), highlighting=2)
```

```{r fig.height=20, fig.width=25}
t1 <-  df_time_reason %>%
  select(time_hour,Lighting) %>%
  group_by(time_hour, Lighting) %>%
  summarise(Freq=n()) %>%
  ungroup()

t2 <- df_time_reason %>%
  select(time_hour,RoadDescriptor) %>%
  group_by(time_hour, RoadDescriptor) %>%
  summarise(Freq=n()) %>%
  ungroup()

t3 <- df_time_reason %>%
  select(time_hour,TrafficControlDevice) %>%
  group_by(time_hour, TrafficControlDevice) %>%
  summarise(Freq=n()) %>%
  ungroup()

t4 <- df_time_reason %>%
  select(time_hour,CrashDescriptor) %>%
  group_by(time_hour, CrashDescriptor) %>%
  summarise(Freq=n()) %>%
  ungroup()

t5 <- df_time_reason %>%
  select(time_hour,Collision_Detail) %>%
  group_by(time_hour, Collision_Detail) %>%
  summarise(Freq=n()) %>%
  ungroup()

t6 <- df_time_reason %>%
  select(time_hour,CollisionTypeDescriptor) %>%
  group_by(time_hour, CollisionTypeDescriptor) %>%
  summarise(Freq=n()) %>%
  ungroup()

mosaic(Lighting~time_hour, direction=c("v", "h"), t1)
mosaic(RoadDescriptor~time_hour, direction=c("v", "h"), t2)
mosaic(TrafficControlDevice~time_hour, direction=c("v", "h"), t3)
mosaic(CrashDescriptor~time_hour, direction=c("v", "h"), t4)
mosaic(Collision_Detail~time_hour, direction=c("v", "h"), t5)
mosaic(CollisionTypeDescriptor~time_hour, direction=c("v", "h"), t6)
```





```{r fig.width=10, message=FALSE, warning=FALSE, echo=FALSE}
df_time_reason %>% 
  group_by(time_hour, Lighting) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  ggplot(aes(x=fct_relevel(factor(Lighting), "Unknown", after=Inf), y=n)) + 
  geom_col()+ 
  facet_wrap(~time_hour, nrow=4, ncol=6)+ 
  labs(x="", y="", title="Lighting Condition vs Time") + theme_bw()

df_time_reason %>% 
  group_by(time_hour, RoadDescriptor) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  ggplot(aes(x=fct_relevel(factor(RoadDescriptor), "U", after=Inf), y=n)) + 
  geom_col()+ 
  facet_wrap(~time_hour, nrow=4, ncol=6)+ 
  labs(x="", y="", title="Road Descriptor vs Time")
  

df_time_reason %>% 
  group_by(time_hour, TrafficControlDevice) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  ggplot(aes(x=fct_relevel(factor(TrafficControlDevice), "N", after=Inf), y=n)) + 
  geom_col()+ 
  facet_wrap(~time_hour, nrow=4, ncol=6)+ 
  labs(x="", y="", title="Traffic Control Device vs Time")


df_time_reason %>% 
  group_by(time_hour, CrashDescriptor) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  ggplot(aes(x=factor(CrashDescriptor), y=n)) + 
  geom_col()+ 
  facet_wrap(~time_hour, nrow=4, ncol=6)+ 
  labs(x="", y="", title="Crash Descriptor vs Time")


df_time_reason %>% 
  filter(Collision_Detail != "Other Motor Vehicle")%>%
  group_by(time_hour, Collision_Detail) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  ggplot(aes(x=factor(Collision_Detail), y=n)) + 
  geom_col()+ 
  facet_wrap(~time_hour, nrow=4, ncol=6)+ 
  labs(x="", y="", title="Collision Details vs Time")

df_time_reason %>% 
  group_by(time_hour, CollisionTypeDescriptor) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  ggplot(aes(x=factor(CollisionTypeDescriptor), y=n)) + 
  geom_col()+ 
  facet_wrap(~time_hour, nrow=4, ncol=6)+ 
  labs(x="", y="", title="Collision Type vs Time")
```

### Day of Week
```{r fig.width=8, message=FALSE, warning=FALSE, echo=FALSE}
df %>%
  select(`Day of Week`, Year) %>%
  group_by(`Day of Week`, Year) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  
ggplot(aes(fct_relevel(`Day of Week`, "Monday", "Tuesday", "Wednesday","Thursday", "Friday", "Saturday", "Sunday"),n,  fill=factor(Year))) +
  geom_bar(stat="identity", position=position_dodge()) + 
  scale_fill_brewer(palette="Set2") +
  labs(x="Day of Week", y="Frequency") +
  theme_minimal()
```

### Month of Year
```{r fig.width=8, message=FALSE, warning=FALSE, echo=FALSE}
df %>% select(Date) %>%
  mutate(Month = month(Date)) %>%
  group_by(Month) %>%
  summarize(n = n()) %>%

ggplot(aes(factor(Month),n)) + 
  geom_col(fill="#2470b9") +
  labs(x="Month", y="Frequency") +
  theme_minimal()
```


## Where
```{r echo=FALSE, fig.height=20, fig.width=30, message=FALSE, warning=FALSE}
ny_county <- subset(map_data("county"), region == "new york") 
  
df_county <- right_join(df %>% 
                         group_by(`County Name`) %>%
                         summarise(n=n()) %>%
                         mutate(subregion = sub("\\.", "",tolower(`County Name`))) %>%
                         select(subregion, n), 
                       ny_county, 
                       by = "subregion") %>%
  select(subregion, n, long, lat, group) %>%
  drop_na()

lower_state <- df_county %>% 
  filter(n>50000) %>% 
  group_by(subregion) %>% 
  summarise(long=mean(long), lat=mean(lat))

embed_plot <- df_county %>% 
  filter(n>50000) %>%
ggplot(aes(x=long, y=lat)) +
  geom_polygon(aes(group = group, fill=n), color = "grey") +
  with(lower_state, annotate(geom="text", x = long, y = lat,
                             label=subregion, size=2)) +
  labs(title = "Long Island Details", x = "longitude", y = "latitude") +
  scale_fill_gradient(low="white", high="darkgreen") +
  theme(panel.background = element_blank()) 

ny_county_distinct <- ny_county %>% 
  group_by(subregion) %>% 
  summarise(long=mean(long), lat=mean(lat))

ggplot(data=df_county, aes(x=long, y=lat)) +
  geom_polygon(aes(group = group, fill=n), color = "grey") +
  with(ny_county_distinct, annotate(geom="text", x = long, y = lat, 
                                    label=subregion, size=3)) +
  labs(title = "New York State Crash by Counties", x = "longitude", y = "latitude") +
  scale_fill_gradient(low="white", high="darkgreen") +
  theme(panel.background = element_blank(), plot.title = element_text(hjust = 0.5)) +
  inset_element(embed_plot,0.01, 0.01, 0.35, 0.35)
```

