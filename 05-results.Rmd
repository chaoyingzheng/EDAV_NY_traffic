# Results

```{r message=FALSE, warning=FALSE, include=FALSE}
library(readr)
df <- read_csv("C:/Users/chaoy/Desktop/Fall2021/5702_EDAV/finalproject_data/cash_information_clean.csv")

# df[sapply(df, is.character)] <- lapply(df[sapply(df, is.character)], as.factor)
```

## When
```{r include=FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(vcd)
library(patchwork)
```

### Time in Day
First, we explore when crashes happen the most, and the corresponding reasons. (Todo: x-axis label update to 0:00?)
```{r fig.width=8, message=FALSE, warning=FALSE, echo=FALSE}
df_time <- df %>% select(Time, Year) %>%
  mutate(hour = hour(Time)) %>%
  group_by(hour, Year) %>%
  summarize(n = n()) %>%
  ungroup()

ggplot(df_time, aes(hour,n, fill=factor(Year))) + 
  geom_bar(stat="identity", position=position_dodge()) + 
  scale_fill_brewer(palette="Set2") +
  theme_minimal()
```
Here is an overview of number of crash occur in 24 hours in 2018 and 2019. Firstly, there are three peaks in the plot: 0:00, 8:00 and 17:00. Commuting peak can be considered as the major reason for peaks at 8:00 and 17:00. The reason for 0:00 will be explored in details later. Secondly, we assume that `Lighting Conditions`, `Road Descriptor`, `Traffic Control Device`, `Crash Descriptor` and `Collision Type Descriptor` are highly correlated with the hour in a day. The following mosaic plots and histograms will examine each variable independent with time. Also `Collision_Detail` will be used to see what the actual reasons for crashing in each hour. 

```{r message=FALSE, warning=FALSE, echo=FALSE}
# Extract Columns for Time Analysis and Data Cleaning 
df_time_reason<- df %>% 
  mutate(time_hour = hour(Time)) %>%
  mutate(`Time` = factor(paste(as.character(time_hour), ":00", sep="")), 
         Lighting = ifelse(str_detect(`Lighting Conditions`, "Dark-Road"), 
                                        sub("^\\S+\\s+","", `Lighting Conditions`), as.character(`Lighting Conditions`)), 
          RoadDescriptor = abbreviate(`Road Descriptor`, 1, named = FALSE), 
         CrashDescriptor = abbreviate(`Crash Descriptor`, 1, named=FALSE), 
         CollisionTypeDescriptor = `Collision Type Descriptor`) %>%
  select(`Time`, time_hour, CrashDescriptor, Lighting, RoadDescriptor,  `Traffic Control Device`, Collision_Detail, Collision_Type, CollisionTypeDescriptor)

# dataframe for mosaic plots
t1 <-  df_time_reason %>%
  select(time_hour,Lighting) %>%
  mutate(Time = time_hour) %>%
  group_by(Time, Lighting) %>%
  summarise(Freq=n()) %>%
  ungroup()
t1$Lighting <- fct_relevel(t1$Lighting,"Unknown", after=Inf)
  
t2 <- df_time_reason %>%
  select(time_hour,RoadDescriptor) %>%
  mutate(Time = time_hour) %>%
  group_by(Time, RoadDescriptor) %>%
  summarise(Freq=n()) %>%
  ungroup()
t2$RoadDescriptor <- fct_recode(t2$RoadDescriptor, CG="CaG", CH="CaHC", CL="CaL", SH="SaHC", SG="SaG", SL="SaL", U="U")

t4 <- df_time_reason %>%
  select(time_hour,CrashDescriptor) %>%
  mutate(Time = time_hour) %>%
  group_by(Time, CrashDescriptor) %>%
  summarise(Freq=n()) %>%
  ungroup()

t6 <- df_time_reason %>%
  select(time_hour,CollisionTypeDescriptor) %>%
  mutate(Time = time_hour) %>%
  group_by(Time, CollisionTypeDescriptor) %>%
  summarise(Freq=n()) %>%
  ungroup()
t6$CollisionTypeDescriptor <- fct_recode(t6$CollisionTypeDescriptor, H="HEAD ON", `0`="LEFT TURN (0)", `3`="LEFT TURN (3)", 
                                         O="OTHER", OT="OVERTAKING", RE="REAR END", RA="RIGHT ANGLE", `5`="RIGHT TURN (5)", 
                                         `6`="RIGHT TURN (6)", S="SIDESWIPE", U="Unknown")
```

**Lighting Condition**
```{r fig.width=15, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
mosaic(Lighting~Time, direction=c("v", "h"), t1)
```

**Road Surface Condition**
```{r fig.width=15, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
mosaic(RoadDescriptor~Time, direction=c("v", "h"), t2)
```

**Demage Severity **
```{r fig.width=15,fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
mosaic(CrashDescriptor~Time, direction=c("v", "h"), t4)
```
**Collision Type Description**

```{r fig.width=15, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
mosaic(CollisionTypeDescriptor~Time, direction=c("v", "h"), t6)
```


**Traffic Control Condition**
```{r fig.width=10, fig.height=10, echo=FALSE}
h1 <- df_time_reason %>% 
  group_by(time_hour, `Traffic Control Device`) %>% summarise(n=n()) %>%
  top_n(6) %>% ungroup()

h1$`Traffic Control Device` <- h1$`Traffic Control Device` %>%
  fct_relevel("None") %>% 
  fct_recode(NP="No Passing Zone", None="None", Other="Other", Stop="Stop Sign", Signal="Traffic Signal", Y="Yield Sign", U="Unknown")

ggplot(h1, aes(x=`Traffic Control Device`, y=n)) + geom_col() + facet_wrap(~time_hour, nrow=6, ncol=4)
```


**Collision Details**
```{r fig.width=10, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
h2 <- df_time_reason %>% 
  filter(Collision_Type != "Collision With" ) %>%
  group_by(time_hour, Collision_Detail) %>%
  summarise(n=n()) %>%
  top_n(5) %>%
  ungroup()

h2$Collision_Detail <- h2$Collision_Detail %>% fct_recode(E="Earth Embankment/Rock Cut/Ditch", G="Guide Rail - Not At End", Tree="Tree",
                                                          U="Light Support/Utility Pole", Other="Other Fixed Object*", Sign="Sign Post") %>%
  fct_relevel("Other", "Sign", after=Inf)

ggplot(h2, aes(x=factor(Collision_Detail), y=n)) + 
geom_col(fill="#8da675")+ 
facet_wrap(~time_hour, nrow=6, ncol=4)+ 
labs(x="", y="", title="Collision Details vs Time")
```


```{r fig.width=10, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
h3 <- df_time_reason %>% 
  filter(Collision_Type == "Collision With" ) %>% #, Collision_Detail != "Other Motor Vehicle")%>%
  group_by(time_hour, Collision_Detail) %>%
  summarise(n=n()) %>%
  ungroup()

h3$Collision_Detail <- h3$Collision_Detail %>% fct_recode(Ani="Animal", Bike="Bicyclist", S="In-Line Skater", Vehicle="Other Motor Vehicle",
                                  O="Other Object (Not Fixed)*", P="Pedestrian", Train="Railroad Train") %>%
  fct_relevel('Vehicle', 'Ani','P')

ggplot(h3, aes(x=factor(Collision_Detail), y=n)) + 
geom_col(fill="#8da675")+ 
facet_wrap(~time_hour, nrow=6, ncol=4)+ 
labs(x="", y="", title="Collision Details vs Time")
```


### Day of Week
```{r fig.width=8, message=FALSE, warning=FALSE, echo=FALSE}
df %>%
  select(`Day of Week`, Year) %>%
  group_by(`Day of Week`, Year) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  
ggplot(aes(fct_relevel(`Day of Week`, "Monday", "Tuesday", "Wednesday","Thursday", "Friday", "Saturday", "Sunday"),n,  fill=factor(Year))) +
  geom_bar(stat="identity", position=position_dodge()) + 
  scale_fill_brewer(palette="Set2") +
  labs(x="Day of Week", y="Frequency") +
  theme_minimal()
```

### Month of Year
```{r fig.width=8, message=FALSE, warning=FALSE, echo=FALSE}
df %>% select(Date) %>%
  mutate(Month = month(Date)) %>%
  group_by(Month) %>%
  summarize(n = n()) %>%

ggplot(aes(factor(Month),n)) + 
  geom_col(fill="#2470b9") +
  labs(x="Month", y="Frequency") +
  theme_minimal()
```


## Where
```{r echo=FALSE, fig.height=20, fig.width=30, message=FALSE, warning=FALSE}
ny_county <- subset(map_data("county"), region == "new york") 
  
df_county <- right_join(df %>% 
                         group_by(`County Name`) %>%
                         summarise(n=n()) %>%
                         mutate(subregion = sub("\\.", "",tolower(`County Name`))) %>%
                         select(subregion, n), 
                       ny_county, 
                       by = "subregion") %>%
  select(subregion, n, long, lat, group) %>%
  drop_na()

lower_state <- df_county %>% 
  filter(n>50000) %>% 
  group_by(subregion) %>% 
  summarise(long=mean(long), lat=mean(lat))

embed_plot <- df_county %>% 
  filter(n>50000) %>%
ggplot(aes(x=long, y=lat)) +
  geom_polygon(aes(group = group, fill=n), color = "grey") +
  with(lower_state, annotate(geom="text", x = long, y = lat,
                             label=subregion, size=2)) +
  labs(title = "Long Island Details", x = "longitude", y = "latitude") +
  scale_fill_gradient(low="white", high="darkgreen") +
  theme(panel.background = element_blank()) 

ny_county_distinct <- ny_county %>% 
  group_by(subregion) %>% 
  summarise(long=mean(long), lat=mean(lat))

ggplot(data=df_county, aes(x=long, y=lat)) +
  geom_polygon(aes(group = group, fill=n), color = "grey") +
  with(ny_county_distinct, annotate(geom="text", x = long, y = lat, 
                                    label=subregion, size=3)) +
  labs(title = "New York State Crash by Counties", x = "longitude", y = "latitude") +
  scale_fill_gradient(low="white", high="darkgreen") +
  theme(panel.background = element_blank(), plot.title = element_text(hjust = 0.5)) +
  inset_element(embed_plot,0.01, 0.01, 0.35, 0.35)
```

