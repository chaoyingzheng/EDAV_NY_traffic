# Results

```{r message=FALSE, warning=FALSE, include=FALSE}
library(readr)
df <- read_csv("C:/Users/chaoy/Desktop/Fall2021/5702_EDAV/finalproject_data/cash_information_clean.csv")

#df <- read.csv("~/Downloads/cash_information_clean.csv")

#df[sapply(df, is.character)] <- lapply(df[sapply(df, is.character)], as.factor)
```

## When
```{r include=FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(vcd)
library(patchwork)
library(RColorBrewer)
```

### Time in Day
First, we explore when crashes happen the most, and the corresponding reasons. (Todo: x-axis label update to 0:00?)
```{r fig.width=8, message=FALSE, warning=FALSE, echo=FALSE}
df_time <- df %>% select(Time, Year) %>%
  mutate(hour = hour(Time)) %>%
  group_by(hour, Year) %>%
  summarize(n = n()) %>%
  ungroup()

ggplot(df_time, aes(hour,n, fill=factor(Year))) + 
  geom_bar(stat="identity", position=position_dodge()) + 
  scale_fill_brewer(palette="Set2") +
  theme_minimal()
```
Here is an overview of number of crash occur in 24 hours in 2018 and 2019. Firstly, there are three peaks in the plot: 0:00, 8:00 and 17:00. Commuting peak can be considered as the major reason for peaks at 8:00 and 17:00. The reason for 0:00 will be explored in details later. Secondly, we assume that `Lighting Conditions`, `Road Descriptor`, `Traffic Control Device`, `Crash Descriptor` and `Collision Type Descriptor` are highly correlated with the hour in a day. The following histograms will examine this assumption. Also we will use `Collision_Detail` to see what the actual reasons for crashing in each hour. 

```{r fig.height=15, fig.width=20}

# Extract Columns for Time Analysis and Data Cleaning 
df_time_reason<- df %>% 
  mutate(time_hour = hour(Time)) %>%
  mutate(time_hour = factor(time_hour), 
         Lighting = ifelse(str_detect(`Lighting Conditions`, "Dark-Road"), 
                                        sub("^\\S+\\s+","", `Lighting Conditions`), as.character(`Lighting Conditions`)), 
          RoadDescriptor = abbreviate(`Road Descriptor`, 1, named = FALSE), 
         TrafficControlDevice = abbreviate(`Traffic Control Device`, 1, named = FALSE), 
         CrashDescriptor = abbreviate(`Crash Descriptor`, 1, named=FALSE), 
         CollisionTypeDescriptor = `Collision Type Descriptor`) %>%
  select(time_hour, CrashDescriptor, Lighting, RoadDescriptor, TrafficControlDevice, Collision_Detail, CollisionTypeDescriptor)

# pairs(table(df_time_reason), highlighting=2)
```

```{r fig.height=20, fig.width=25}
t1 <-  df_time_reason %>%
  select(time_hour,Lighting) %>%
  group_by(time_hour, Lighting) %>%
  summarise(Freq=n()) %>%
  ungroup()

t2 <- df_time_reason %>%
  select(time_hour,RoadDescriptor) %>%
  group_by(time_hour, RoadDescriptor) %>%
  summarise(Freq=n()) %>%
  ungroup()

t3 <- df_time_reason %>%
  select(time_hour,TrafficControlDevice) %>%
  group_by(time_hour, TrafficControlDevice) %>%
  summarise(Freq=n()) %>%
  ungroup()

t4 <- df_time_reason %>%
  select(time_hour,CrashDescriptor) %>%
  group_by(time_hour, CrashDescriptor) %>%
  summarise(Freq=n()) %>%
  ungroup()

t5 <- df_time_reason %>%
  select(time_hour,Collision_Detail) %>%
  group_by(time_hour, Collision_Detail) %>%
  summarise(Freq=n()) %>%
  ungroup()

t6 <- df_time_reason %>%
  select(time_hour,CollisionTypeDescriptor) %>%
  group_by(time_hour, CollisionTypeDescriptor) %>%
  summarise(Freq=n()) %>%
  ungroup()

mosaic(Lighting~time_hour, direction=c("v", "h"), t1)
mosaic(RoadDescriptor~time_hour, direction=c("v", "h"), t2)
mosaic(TrafficControlDevice~time_hour, direction=c("v", "h"), t3)
mosaic(CrashDescriptor~time_hour, direction=c("v", "h"), t4)
mosaic(Collision_Detail~time_hour, direction=c("v", "h"), t5)
mosaic(CollisionTypeDescriptor~time_hour, direction=c("v", "h"), t6)
```



Todo: analysis, add each col's level in the description/analysis, conclude whether correlated with time
Todo (code): x-axis label clean up(rotation or abbreviate), add full name if abbreviate

```{r fig.width=10, message=FALSE, warning=FALSE, echo=FALSE}
df_time_reason %>% 
  group_by(time_hour, Lighting) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  ggplot(aes(x=fct_relevel(factor(Lighting), "Unknown", after=Inf), y=n)) + 
  geom_col(fill="#8da675")+ 
  facet_wrap(~time_hour, nrow=4, ncol=6)+ 
  labs(x="", y="", title="Lighting Condition vs Time") + theme_bw()

df_time_reason %>% 
  group_by(time_hour, RoadDescriptor) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  ggplot(aes(x=fct_relevel(factor(RoadDescriptor), "U", after=Inf), y=n)) + 
  geom_col(fill="#8da675")+ 
  facet_wrap(~time_hour, nrow=4, ncol=6)+ 
  labs(x="", y="", title="Road Descriptor vs Time")
  

df_time_reason %>% 
  group_by(time_hour, TrafficControlDevice) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  ggplot(aes(x=fct_relevel(factor(TrafficControlDevice), "N", after=Inf), y=n)) + 
  geom_col(fill="#8da675")+ 
  facet_wrap(~time_hour, nrow=4, ncol=6)+ 
  labs(x="", y="", title="Traffic Control Device vs Time")


df_time_reason %>% 
  group_by(time_hour, CrashDescriptor) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  ggplot(aes(x=factor(CrashDescriptor), y=n)) + 
  geom_col(fill="#8da675")+ 
  facet_wrap(~time_hour, nrow=4, ncol=6)+ 
  labs(x="", y="", title="Crash Descriptor vs Time")


df_time_reason %>% 
  filter(Collision_Detail != "Other Motor Vehicle")%>%
  group_by(time_hour, Collision_Detail) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  ggplot(aes(x=factor(Collision_Detail), y=n)) + 
  geom_col(fill="#8da675")+ 
  facet_wrap(~time_hour, nrow=4, ncol=6)+ 
  labs(x="", y="", title="Collision Details vs Time")

df_time_reason %>% 
  group_by(time_hour, CollisionTypeDescriptor) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  ggplot(aes(x=factor(CollisionTypeDescriptor), y=n)) + 
  geom_col(fill="#8da675")+ 
  facet_wrap(~time_hour, nrow=4, ncol=6)+ 
  labs(x="", y="", title="Collision Type vs Time")
```

### Day of Week
```{r fig.width=8, message=FALSE, warning=FALSE, echo=FALSE}
df %>%
  select(`Day of Week`, Year) %>%
  group_by(`Day of Week`, Year) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  
ggplot(aes(fct_relevel(`Day of Week`, "Monday", "Tuesday", "Wednesday","Thursday", "Friday", "Saturday", "Sunday"),n,  fill=factor(Year))) +
  geom_bar(stat="identity", position=position_dodge()) + 
  scale_fill_brewer(palette="Set2") +
  labs(x="Day of Week", y="Frequency") +
  theme_minimal()
```

### Month of Year
```{r fig.width=8, message=FALSE, warning=FALSE, echo=FALSE}
df %>% select(Date) %>%
  mutate(Month = month(Date)) %>%
  group_by(Month) %>%
  summarize(n = n()) %>%

ggplot(aes(factor(Month),n)) + 
  geom_col(fill="#35978F", alpha = 0.9) +
  labs(x="Month", y="Frequency") + 
  ggtitle("Car Crashes Occurred Each Month during 2018-2019") + 
  theme_minimal() 
```
    The bar plots above shows the number of car crashes occurred on each month accumulating 2018 and 2019. While the differences between each month are not tremendous, we could still observe that the number of crashes that happened in October, November, December and January are higher than the other months in a year. 
    Remarkably, the four months that have highest number of car crashes occurred are cluster together, and these four months covers almost the whole winter season. Considering the season factor, the weather conditions are different in winter than other season, and the daytime are shorter in winter which the lighting condition could be different as well. 

```{r fig.width=8, message=FALSE, warning=FALSE, echo=FALSE}

df_month <- df %>% 
  mutate(Month = month(Date))

df_light <- df_month %>%
  select(Month, Lighting.Conditions) %>%
  group_by(Month, Lighting.Conditions) %>%
  summarise(Freq=n()) %>%
  mutate(RelFreq = Freq / sum(Freq)) %>%
  ungroup()

fillcolors <- brewer.pal(6, "Blues")
df_light$Lighting.Conditions <- factor(df_light$Lighting.Conditions, levels = c("Unknown", "Daylight", "Dawn", "Dusk", "Dark-Road Lighted", "Dark-Road Unlighted"))
ggplot(df_light, aes(x = factor(Month), y = RelFreq, fill = Lighting.Conditions)) + 
  geom_col() + 
  scale_fill_manual(values = fillcolors) + 
  ggtitle("Lighting Conditions of Car Crashes") + 
  labs(x = "Month", y = "Proportion") + 
  theme_classic()

#mosaic(Lighting.Conditions ~ Month, direction=c("v", "h"), highlighting_fill = c("#F7FBFF", "#C6DBEF", "#6BAED6", "#4292C6", "#2171B5", "#084594"), df_light)

```


## Where
```{r echo=FALSE, fig.height=20, fig.width=30, message=FALSE, warning=FALSE}
ny_county <- subset(map_data("county"), region == "new york") 
  
df_county <- right_join(df %>% 
                         group_by(`County Name`) %>%
                         summarise(n=n()) %>%
                         mutate(subregion = sub("\\.", "",tolower(`County Name`))) %>%
                         select(subregion, n), 
                       ny_county, 
                       by = "subregion") %>%
  select(subregion, n, long, lat, group) %>%
  drop_na()

lower_state <- df_county %>% 
  filter(n>50000) %>% 
  group_by(subregion) %>% 
  summarise(long=mean(long), lat=mean(lat))

embed_plot <- df_county %>% 
  filter(n>50000) %>%
ggplot(aes(x=long, y=lat)) +
  geom_polygon(aes(group = group, fill=n), color = "grey") +
  with(lower_state, annotate(geom="text", x = long, y = lat,
                             label=subregion, size=2)) +
  labs(title = "Long Island Details", x = "longitude", y = "latitude") +
  scale_fill_gradient(low="white", high="darkgreen") +
  theme(panel.background = element_blank()) 

ny_county_distinct <- ny_county %>% 
  group_by(subregion) %>% 
  summarise(long=mean(long), lat=mean(lat))

ggplot(data=df_county, aes(x=long, y=lat)) +
  geom_polygon(aes(group = group, fill=n), color = "grey") +
  with(ny_county_distinct, annotate(geom="text", x = long, y = lat, 
                                    label=subregion, size=3)) +
  labs(title = "New York State Crash by Counties", x = "longitude", y = "latitude") +
  scale_fill_gradient(low="white", high="darkgreen") +
  theme(panel.background = element_blank(), plot.title = element_text(hjust = 0.5)) +
  inset_element(embed_plot,0.01, 0.01, 0.35, 0.35)
```


## How

**Top 10 Crahes Detail**
```{r fig.width=8, message=FALSE, warning=FALSE, echo=FALSE}

df_detail <- df %>% 
  group_by(Collision_Detail) %>%
  summarize(n = n()) %>%
  slice_max(order_by = n, n = 10)

ggplot(df_detail, aes(x = fct_reorder(Collision_Detail, n, .desc = TRUE), y=n)) + 
  geom_col(fill="Purple", alpha = 0.9) +
  labs(x="Crash Detail", y="Frequency") + 
  ggtitle("Top 10 Car Crashes Deatails") + 
  theme_minimal()

```


**Road Surface patterns correspond to these top 10 type of Crashes**
```{r fig.width=8, message=FALSE, warning=FALSE, echo=FALSE}

tenMost <- list(df_detail$Collision_Detail)

df_collision <- df_month %>%
  filter(Collision_Detail %in% df_detail$Collision_Detail) %>%
  select(Collision_Detail, Road.Surface.Conditions) %>%
  group_by(Collision_Detail, Road.Surface.Conditions) %>%
  summarise(Freq=n()) %>%
  mutate(RelFreq = Freq / sum(Freq)) %>%
  ungroup()

fillcolors <- brewer.pal(8, "Blues")
ggplot(df_collision, aes(x = RelFreq, y = fct_reorder(Collision_Detail, Freq, .desc = FALSE), fill = Road.Surface.Conditions)) + 
  geom_col() + 
  scale_fill_manual(values = fillcolors) + 
  labs(x = "Proportion", y = "Collision Detail") +
  ggtitle("Road Surface Condition of the Corresponding Type of Crashes") + 
  theme_classic()

```

```{r fig.width=8, message=FALSE, warning=FALSE, echo=FALSE}

df_RoSur <- df %>% 
  group_by(Road.Surface.Conditions) %>%
  summarize(n = n())

ggplot(df_RoSur, aes(x = fct_reorder(Road.Surface.Conditions, n, .desc = TRUE), y=n)) + 
  geom_col(fill="DarkBlue", alpha = 0.9) +
  labs(x="Road Surface Conditions", y="Frequency") + 
  ggtitle("Road Surface Conditions When Car Crashes Occurred") + 
  theme_minimal()

```



**Combination: Lighting Conditions and Road Surface Condition**
```{r fig.width=8, message=FALSE, warning=FALSE, echo=FALSE}

df_light <- df %>%
  select(Road.Surface.Conditions, Lighting.Conditions) %>%
  group_by(Road.Surface.Conditions, Lighting.Conditions) %>%
  summarise(Freq=n()) %>%
  mutate(RelFreq = Freq / sum(Freq)) %>%
  ungroup()

fillcolors <- brewer.pal(8, "Blues")
df_light$Lighting.Conditions <- factor(df_light$Lighting.Conditions, levels = c("Unknown", "Daylight", "Dawn", "Dusk", "Dark-Road Lighted", "Dark-Road Unlighted"))
ggplot(df_light, aes(x = Road.Surface.Conditions, y = RelFreq, fill = Lighting.Conditions)) + 
  geom_col() + 
  scale_fill_manual(values = fillcolors) + 
  ggtitle("Lighting and Road Surface Conditions of Car Crashes") + 
  labs(x = "Road Surface Condition", y = "Proportion") + 
  theme_classic()

```

